<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSense - Research-Grade Plant Stress Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5a27 0%, #4a7c59 50%, #667eea 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 35px;
            max-width: 1400px;
            margin: 0 auto;
            backdrop-filter: blur(15px);
        }

        .header {
            text-align: center;
            margin-bottom: 35px;
            border-bottom: 3px solid #2d5a27;
            padding-bottom: 25px;
        }

        .header h1 {
            color: #2d5a27;
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            color: #4a7c59;
            font-size: 1.3em;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .header .research-tag {
            background: linear-gradient(45deg, #2d5a27, #4a7c59);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1em;
            display: inline-block;
            margin-top: 10px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 20px;
            padding: 25px;
            border: 2px solid #e9ecef;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        }

        .section h3 {
            color: #2d5a27;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a27;
            box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.1);
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .sensor-card {
            background: white;
            padding: 18px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }

        .sensor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: #2d5a27;
        }

        .sensor-card h4 {
            color: #2d5a27;
            margin-bottom: 8px;
            font-size: 1em;
            font-weight: 600;
        }

        .sensor-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .sensor-unit {
            color: #666;
            font-size: 0.9em;
        }

        .sensor-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-warning { background: #ffc107; }
        .status-danger { background: #dc3545; }

        .disease-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }

        .disease-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .confidence-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .chat-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 2px solid #e9ecef;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .chat-header {
            background: linear-gradient(135deg, #2d5a27, #4a7c59);
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
        }

        .bot-message .message-content {
            background: white;
            color: #333;
            border: 2px solid #e9ecef;
            margin-right: auto;
        }

        .message-header {
            font-size: 0.85em;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        .chat-input-container {
            display: flex;
            padding: 20px;
            background: white;
            border-top: 2px solid #e9ecef;
            gap: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .chat-input:focus {
            border-color: #2d5a27;
            box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2d5a27, #4a7c59);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(45, 90, 39, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .research-footer {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }

        .placeholder-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            margin-right: auto;
            max-width: 85%;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2d5a27;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sensor-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .disease-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌱 AgriSense</h1>
            <div class="subtitle">Real-Time Plant Stress Detection & Advisory System</div>
            <div class="research-tag">Research-Grade Implementation | Gas Sensors + Image Processing</div>
        </div>

        <div class="main-grid">
            <!-- Configuration Section -->
            <!-- <div class="section">
                <h3>🔧 System Configuration</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="plant-type">Target Plant:</label>
                        <select id="plant-type">
                            <option value="tomato">🍅 Tomato (Research Focus)</option>
                            <!-- <option value="other">🌿 Other Plants</option> -->
                        </select>
                    </div>
                </div>
            </div> -->

            <!-- Gas Sensor Data Section -->
            <div class="section">
                <h3>🔬 Gas Sensor Readings</h3>
                <div class="placeholder-note">
                    📝 Note: Update threshold values based on your research data
                </div>
                <div class="sensor-grid">
                    <div class="sensor-card">
                        <div class="sensor-status" id="mq135-status"></div>
                        <h4>MQ-135</h4>
                        <div class="form-group">
                            <input type="number" id="co2-reading" placeholder="CO2" step="0.1">
                            <div class="sensor-unit">ppm</div>
                        </div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-status" id="nh3-status"></div>
                        <h4>NH3</h4>
                        <div class="form-group">
                            <input type="number" id="nh3-reading" placeholder="NH3" step="0.1">
                            <div class="sensor-unit">ppm</div>
                        </div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-status" id="mq3-status"></div>
                        <h4>MQ-3</h4>
                        <div class="form-group">
                            <input type="number" id="ethanol-reading" placeholder="Ethanol" step="0.1">
                            <div class="sensor-unit">ppm</div>
                        </div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-status" id="mq136-status"></div>
                        <h4>MQ-136</h4>
                        <div class="form-group">
                            <input type="number" id="h2s-reading" placeholder="H2S" step="0.1">
                            <div class="sensor-unit">ppm</div>
                        </div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-status" id="temp-status"></div>
                        <h4>Temperature</h4>
                        <div class="form-group">
                            <input type="number" id="temp-reading" placeholder="Temp" step="0.1">
                            <div class="sensor-unit">°C</div>
                        </div>
                    </div>
                    <div class="sensor-card">
                        <div class="sensor-status" id="humidity-status"></div>
                        <h4>Humidity</h4>
                        <div class="form-group">
                            <input type="number" id="humidity-reading" placeholder="Humidity" step="0.1">
                            <div class="sensor-unit">%</div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="simulateResearchData()">🧪 Simulate Research Data</button>
            </div>

            <!-- Image Processing Results -->
            <div class="section">
                <h3>📸 CNN Disease Classification</h3>
                <div class="placeholder-note">
                    📝 Note: Replace with your 10 tomato disease classes
                </div>
                <div class="disease-section">
                    <div class="disease-grid">
                        <div class="form-group">
                            <label for="detected-disease">Detected Disease:</label>
                            <select id="detected-disease">
                                <option value="">Select detected disease...</option>
                                <option value="healthy">Healthy</option>
                                <option value="early_blight">Early Blight</option>
                                <option value="late_blight">Late Blight</option>
                                <option value="leaf_mold">Leaf Mold</option>
                                <option value="septoria_leaf_spot">Septoria Leaf Spot</option>
                                <option value="spider_mites">Spider Mites</option>
                                <option value="target_spot">Target Spot</option>
                                <option value="yellow_leaf_curl">Yellow Leaf Curl Virus</option>
                                <option value="mosaic_virus">Mosaic Virus</option>
                                <option value="bacterial_spot">Bacterial Spot</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="confidence-score">Confidence:</label>
                            <input type="number" id="confidence-score" placeholder="0.00" min="0" max="1" step="0.01">
                        </div>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidence-fill" style="width: 0%"></div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="simulateCNNResults()">🤖 Simulate CNN Results</button>
            </div>

            <!-- Research Assistant -->
            <div class="section">
                <h3>📚 Research Context</h3>
                <div class="form-group">
                    <label for="research-notes">Additional Context:</label>
                    <textarea id="research-notes" rows="4" placeholder="Enter any additional research context, environmental conditions, or specific observations..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="performResearchAnalysis()">🔬 Perform Research Analysis</button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="section">
            <div class="chat-container">
                <div class="chat-header">
                    🤖 AgriSense Research Assistant | VOC Analysis + Disease Detection
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot-message">
                        <div class="message-header">Research Assistant</div>
                        <div class="message-content">
                            🌱 <strong>Welcome to AgriSense Research System!</strong><br><br>
                            I'm your specialized research assistant trained on plant stress detection literature. I can analyze:
                            <br>• <strong>Gas Sensor Data:</strong> VOC emissions from MQ-135, MQ-3, MQ-136 sensors
                            <br>• <strong>CNN Results:</strong> Disease classification with confidence scores
                            <br>• <strong>Multi-modal Analysis:</strong> Correlating gas patterns with visual symptoms
                            <br>• <strong>Research Insights:</strong> Based on 20+ peer-reviewed papers
                            <br><br>Enter your sensor readings and CNN results, then ask me for analysis! 🔬
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Ask about VOC patterns, stress correlations, or research insights..." onkeypress="handleKeyPress(event)">
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="send-button" onclick="sendMessage()">Send</button>
                        <button class="btn btn-secondary" onclick="clearChat()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="research-footer">
            <strong>AgriSense Research Implementation</strong> | Based on multi-sensor VOC detection and CNN-based disease classification<br>
            <em>Developed for precision agriculture and early plant stress detection research</em>
        </div>
    </div>

    <script>
        // Global variables
        let currentSensorData = {};
        let currentDiseaseData = {};
        let isProcessing = false;

        // Hardcoded API key - Replace 'YOUR_API_KEY_HERE' with your actual Gemini API key
        const GEMINI_API_KEY = 'AIzaSyDy1TwCnw4t9gY3EiIIJcVKFc-_rJUXd4g';

        // Research-grade sensor simulation based on literature
        function simulateResearchData() {
            // Based on research papers - simulate realistic VOC emission patterns
            const stressTypes = ['healthy', 'drought_stress', 'pathogen_stress', 'nutrient_deficiency'];
            const selectedStress = stressTypes[Math.floor(Math.random() * stressTypes.length)];

            let readings;
            switch(selectedStress) {
                case 'healthy':
                    readings = {
                        co2: 400 + (Math.random() - 0.5) * 50,
                        nh3: 2 + (Math.random() - 0.5) * 1,
                        ethanol: 5 + (Math.random() - 0.5) * 2,
                        h2s: 1 + (Math.random() - 0.5) * 0.5,
                        temperature: 22 + (Math.random() - 0.5) * 4,
                        humidity: 65 + (Math.random() - 0.5) * 15
                    };
                    break;
                case 'drought_stress':
                    readings = {
                        co2: 450 + (Math.random() - 0.5) * 70,
                        nh3: 4 + (Math.random() - 0.5) * 2,
                        ethanol: 12 + (Math.random() - 0.5) * 5,
                        h2s: 3 + (Math.random() - 0.5) * 1,
                        temperature: 28 + (Math.random() - 0.5) * 6,
                        humidity: 45 + (Math.random() - 0.5) * 10
                    };
                    break;
                case 'pathogen_stress':
                    readings = {
                        co2: 380 + (Math.random() - 0.5) * 60,
                        nh3: 8 + (Math.random() - 0.5) * 3,
                        ethanol: 18 + (Math.random() - 0.5) * 7,
                        h2s: 2 + (Math.random() - 0.5) * 1,
                        temperature: 24 + (Math.random() - 0.5) * 5,
                        humidity: 70 + (Math.random() - 0.5) * 12
                    };
                    break;
                case 'nutrient_deficiency':
                    readings = {
                        co2: 420 + (Math.random() - 0.5) * 80,
                        nh3: 6 + (Math.random() - 0.5) * 2.5,
                        ethanol: 8 + (Math.random() - 0.5) * 3,
                        h2s: 1.5 + (Math.random() - 0.5) * 0.8,
                        temperature: 23 + (Math.random() - 0.5) * 4,
                        humidity: 60 + (Math.random() - 0.5) * 18
                    };
                    break;
            }

            currentSensorData = readings;
            updateSensorInputs(readings);
            updateSensorStatus(readings);
            
            addMessage(`🧪 <strong>Research Data Simulated:</strong> Generated ${selectedStress.replace('_', ' ')} pattern based on literature findings.`, 'bot');
        }

        function updateSensorInputs(readings) {
            document.getElementById('co2-reading').value = readings.co2.toFixed(1);
            document.getElementById('nh3-reading').value = readings.nh3.toFixed(1);
            document.getElementById('ethanol-reading').value = readings.ethanol.toFixed(1);
            document.getElementById('h2s-reading').value = readings.h2s.toFixed(1);
            document.getElementById('temp-reading').value = readings.temperature.toFixed(1);
            document.getElementById('humidity-reading').value = readings.humidity.toFixed(1);
        }

        function updateSensorStatus(readings) {
            // Set status indicators based on research thresholds
            document.getElementById('mq135-status').className = 'sensor-status ' + 
                (readings.co2 > 480 ? 'status-danger' : readings.co2 > 430 ? 'status-warning' : 'status-good');
            document.getElementById('nh3-status').className = 'sensor-status ' + 
                (readings.nh3 > 7 ? 'status-danger' : readings.nh3 > 4 ? 'status-warning' : 'status-good');
            document.getElementById('mq3-status').className = 'sensor-status ' + 
                (readings.ethanol > 15 ? 'status-danger' : readings.ethanol > 10 ? 'status-warning' : 'status-good');
            document.getElementById('mq136-status').className = 'sensor-status ' + 
                (readings.h2s > 2.5 ? 'status-danger' : readings.h2s > 1.8 ? 'status-warning' : 'status-good');
            document.getElementById('temp-status').className = 'sensor-status ' + 
                (readings.temperature > 30 || readings.temperature < 15 ? 'status-danger' : 
                 readings.temperature > 26 || readings.temperature < 18 ? 'status-warning' : 'status-good');
            document.getElementById('humidity-status').className = 'sensor-status ' + 
                (readings.humidity > 80 || readings.humidity < 40 ? 'status-danger' : 
                 readings.humidity > 75 || readings.humidity < 50 ? 'status-warning' : 'status-good');
        }

        function simulateCNNResults() {
            const diseases = [
                'healthy', 'early_blight', 'late_blight', 'leaf_mold', 'septoria_leaf_spot',
                'spider_mites', 'target_spot', 'yellow_leaf_curl', 'mosaic_virus', 'bacterial_spot'
            ];
            
            const selectedDisease = diseases[Math.floor(Math.random() * diseases.length)];
            const confidence = 0.7 + Math.random() * 0.25; // 70-95% confidence
            
            document.getElementById('detected-disease').value = selectedDisease;
            document.getElementById('confidence-score').value = confidence.toFixed(3);
            
            updateConfidenceBar(confidence);
            
            currentDiseaseData = {
                disease: selectedDisease,
                confidence: confidence
            };
            
            addMessage(`🤖 <strong>CNN Analysis Complete:</strong> Detected ${selectedDisease.replace('_', ' ')} with ${(confidence * 100).toFixed(1)}% confidence.`, 'bot');
        }

        function updateConfidenceBar(confidence) {
            const fill = document.getElementById('confidence-fill');
            fill.style.width = (confidence * 100) + '%';
        }

        // Update confidence bar when manually entered
        document.getElementById('confidence-score').addEventListener('input', function() {
            const confidence = parseFloat(this.value) || 0;
            updateConfidenceBar(confidence);
        });

        function performResearchAnalysis() {
            const sensorData = collectSensorData();
            const diseaseData = collectDiseaseData();
            const context = document.getElementById('research-notes').value;
            
            if (!sensorData.hasData && !diseaseData.hasData) {
                addMessage('⚠️ Please enter sensor readings or CNN results before performing analysis.', 'bot');
                return;
            }

            let analysisRequest = "🔬 **Research Analysis Request:**\n\n";
            
            if (sensorData.hasData) {
                analysisRequest += `**VOC Sensor Readings:**\n`;
                analysisRequest += `• MQ-135 CO2: ${sensorData.co2} ppm\n`;
                analysisRequest += `• NH3: ${sensorData.nh3} ppm\n`;
                analysisRequest += `• MQ-3 Ethanol: ${sensorData.ethanol} ppm\n`;
                analysisRequest += `• MQ-136 H2S: ${sensorData.h2s} ppm\n`;
                analysisRequest += `• Temperature: ${sensorData.temperature}°C\n`;
                analysisRequest += `• Humidity: ${sensorData.humidity}%\n\n`;
            }
            
            if (diseaseData.hasData) {
                analysisRequest += `**CNN Classification:**\n`;
                analysisRequest += `• Detected: ${diseaseData.disease}\n`;
                analysisRequest += `• Confidence: ${(diseaseData.confidence * 100).toFixed(1)}%\n\n`;
            }
            
            if (context) {
                analysisRequest += `**Additional Context:** ${context}\n\n`;
            }
            
            analysisRequest += "Please provide comprehensive research-grade analysis correlating VOC patterns with visual symptoms.";
            
            addMessage(analysisRequest, 'user');
            sendToGemini(analysisRequest);
        }

        function collectSensorData() {
            const co2 = parseFloat(document.getElementById('co2-reading').value);
            const nh3 = parseFloat(document.getElementById('nh3-reading').value);
            const ethanol = parseFloat(document.getElementById('ethanol-reading').value);
            const h2s = parseFloat(document.getElementById('h2s-reading').value);
            const temperature = parseFloat(document.getElementById('temp-reading').value);
            const humidity = parseFloat(document.getElementById('humidity-reading').value);
            
            const hasData = !isNaN(co2) || !isNaN(nh3) || !isNaN(ethanol) || !isNaN(h2s) || !isNaN(temperature) || !isNaN(humidity);
            
            return { co2, nh3, ethanol, h2s, temperature, humidity, hasData };
        }

        function collectDiseaseData() {
            const disease = document.getElementById('detected-disease').value;
            const confidence = parseFloat(document.getElementById('confidence-score').value);
            
            const hasData = disease && !isNaN(confidence);
            
            return { disease, confidence, hasData };
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !isProcessing) {
                sendMessage();
            }
        }

        function sendMessage() {
            if (isProcessing) return;
            
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            sendToGemini(message);
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message';
            typingDiv.id = 'typing-indicator';
            
            typingDiv.innerHTML = `
                <div class="message-header">Research Assistant</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            messageDiv.innerHTML = `
                <div class="message-header">${sender === 'user' ? 'You' : 'Research Assistant'}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="message bot-message">
                    <div class="message-header">Research Assistant</div>
                    <div class="message-content">
                        🌱 <strong>Welcome to AgriSense Research System!</strong><br><br>
                        I'm your specialized research assistant trained on plant stress detection literature. I can analyze:
                        <br>• <strong>Gas Sensor Data:</strong> VOC emissions from MQ-135, MQ-3, MQ-136 sensors
                        <br>• <strong>CNN Results:</strong> Disease classification with confidence scores
                        <br>• <strong>Multi-modal Analysis:</strong> Correlating gas patterns with visual symptoms
                        <br>• <strong>Research Insights:</strong> Based on 20+ peer-reviewed papers
                        <br><br>Enter your sensor readings and CNN results, then ask me for analysis! 🔬
                    </div>
                </div>
            `;
        }

        async function sendToGemini(userMessage) {
            isProcessing = true;
            
            // Collect current sensor and disease data
            const sensorData = collectSensorData();
            const diseaseData = collectDiseaseData();
            const plantType = document.getElementById('plant-type').value;
            const researchNotes = document.getElementById('research-notes').value;

            // Build research-grade prompt
            let researchPrompt = buildResearchPrompt(userMessage, sensorData, diseaseData, plantType, researchNotes);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: researchPrompt
                            }]
                        }]
                    })
                });

                removeTypingIndicator();

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.candidates && data.candidates[0]) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    addMessage(botResponse, 'bot');
                } else if (data.error) {
                    addMessage(`❌ API Error: ${data.error.message || 'Unknown error occurred'}`, 'bot');
                } else {
                    addMessage('❌ Error: Unable to get response from Gemini API. Please check your API key and try again.', 'bot');
                }
            } catch (error) {
                removeTypingIndicator();
                console.error('Error:', error);
                
                if (error.message.includes('HTTP error')) {
                    addMessage('❌ API Error: Please check your Gemini API key and ensure it\'s valid.', 'bot');
                } else {
                    addMessage('❌ Network error. Please check your internet connection and try again.', 'bot');
                }
            } finally {
                isProcessing = false;
            }
        }

        function buildResearchPrompt(userMessage, sensorData, diseaseData, plantType, context) {
            let prompt = `You are an expert AgriSense research assistant specializing in plant stress detection through VOC analysis and disease classification. 

CURRENT DATA:
`;

            if (sensorData.hasData) {
                prompt += `🔬 GAS SENSOR READINGS:
• MQ-135 CO2: ${sensorData.co2 || 'N/A'} ppm
• NH3: ${sensorData.nh3 || 'N/A'} ppm  
• MQ-3 Ethanol: ${sensorData.ethanol || 'N/A'} ppm
• MQ-136 H2S: ${sensorData.h2s || 'N/A'} ppm
• Temperature: ${sensorData.temperature || 'N/A'}°C
• Humidity: ${sensorData.humidity || 'N/A'}%

`;
            }

            if (diseaseData.hasData) {
                prompt += `🤖 CNN DISEASE CLASSIFICATION:
• Detected Disease: ${diseaseData.disease}
• Confidence Score: ${(diseaseData.confidence * 100).toFixed(1)}%

`;
            }

            prompt += `TARGET PLANT: ${plantType}
${context ? `ADDITIONAL CONTEXT: ${context}` : ''}

RESEARCH KNOWLEDGE BASE:
- VOC patterns indicate stress types: Ethanol↑ = drought stress, NH3↑ = pathogen stress, H2S↑ = root problems
- Gas sensor thresholds: CO2 >450ppm (stress), Ethanol >10ppm (drought), NH3 >5ppm (disease)
- Multi-modal correlation: Visual symptoms + VOC patterns improve accuracy
- Early detection: VOC changes occur 24-48h before visible symptoms

USER QUERY: ${userMessage}

Provide research-grade analysis with:
1. Data interpretation based on sensor readings
2. Stress type identification from VOC patterns  
3. Correlation with CNN disease results
4. Actionable recommendations
5. Research insights and references

Response should be academic but practical for farmers.`;

            return prompt;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any stored security notices
            localStorage.removeItem('agrisense_security_notice');
            
            // Set initial sensor status
            updateSensorStatus({
                co2: 400, nh3: 2, ethanol: 5, h2s: 1, temperature: 22, humidity: 65
            });
            
            // Add event listeners for real-time updates
            const sensorInputs = ['co2-reading', 'nh3-reading', 'ethanol-reading', 'h2s-reading', 'temp-reading', 'humidity-reading'];
            sensorInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    const readings = collectSensorData();
                    if (readings.hasData) {
                        updateSensorStatus(readings);
                    }
                });
            });
        });
    </script>
</body>
</html> 